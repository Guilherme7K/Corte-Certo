{% extends "base.html" %}

{% block content %}
<div class="min-h-screen py-20 px-6">
    <div class="container mx-auto max-w-4xl">
        
        <!-- Header -->
        <div class="relative mb-16">
            <!-- Background Pattern -->
            <div class="absolute inset-0 bg-gradient-to-br from-surface to-moss rounded-sm overflow-hidden">
                <div class="absolute inset-0 opacity-5" style="background-image: url('https://www.transparenttextures.com/patterns/stardust.png');"></div>
            </div>
            
            <div class="relative z-10 p-12">
                <div class="flex items-start justify-between flex-wrap gap-6">
                    <div>
                        <a href="{{ url_for('cliente_dashboard') }}" class="inline-flex items-center gap-2 text-sand/60 hover:text-clay mb-4 transition-colors text-sm font-mono">
                            <i class="fa-solid fa-arrow-left"></i>
                            Voltar
                        </a>
                        <h1 class="font-display text-5xl md:text-6xl text-sand font-bold mb-2">
                            Novo Agendamento
                        </h1>
                        <p class="text-sand/60 text-sm font-mono tracking-wide">Escolha o serviço e horário ideal</p>
                    </div>
                    
                    <a href="{{ url_for('logout') }}" 
                       class="bg-transparent border border-sand/20 text-sand px-6 py-3 rounded-sm font-display font-bold text-xs uppercase tracking-widest hover:border-clay hover:text-clay transition-all">
                        <i class="fa-solid fa-arrow-right-from-bracket mr-2"></i>Sair
                    </a>
                </div>
            </div>
        </div>

        <!-- Formulário -->
        <div class="bg-surface border border-sand/10 rounded-sm overflow-hidden">
            <!-- Form -->
            <form method="POST" class="p-12 space-y-10">
                
                <!-- Serviços -->
                <div>
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-[1px] bg-clay"></div>
                        <label class="block text-sand font-display text-2xl font-bold">
                            Serviço
                        </label>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-3">
                        {% for servico in servicos %}
                            <label class="relative cursor-pointer group">
                                <input type="radio" 
                                       name="servico_id" 
                                       value="{{ servico.id }}" 
                                       class="peer sr-only" 
                                       required>
                                
                                <div class="border border-sand/10 rounded-sm p-6 transition-all bg-moss
                                           peer-checked:border-clay peer-checked:bg-surface
                                           hover:border-sand/30">
                                    <div class="flex items-center justify-between gap-6">
                                        <div class="flex-1">
                                            <h3 class="font-display text-xl text-sand mb-2 font-bold">
                                                {{ servico.nome }}
                                            </h3>
                                            <p class="text-sand/60 text-sm mb-3 leading-relaxed">{{ servico.descricao }}</p>
                                            <div class="flex items-center gap-6 text-sm">
                                                <span class="text-sand/50 font-mono">
                                                    <i class="fa-solid fa-clock mr-2 text-clay"></i>
                                                    {{ servico.duracao }} min
                                                </span>
                                                <span class="text-clay font-display font-bold text-xl">
                                                    R$ {{ "%.2f"|format(servico.preco) }}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <!-- Checkmark -->
                                        <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all
                                                   border-sand/30 group-has-[:checked]:bg-clay group-has-[:checked]:border-clay">
                                            <i class="fa-solid fa-check text-sand text-xs transition-opacity
                                                     opacity-0 group-has-[:checked]:opacity-100"></i>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Data e Hora -->
                <div>
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-[1px] bg-clay"></div>
                        <label class="block text-sand font-display text-2xl font-bold">
                            Data e Horário
                        </label>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Data -->
                        <div>
                            <label for="data" class="block text-sand/60 text-xs font-mono uppercase tracking-widest mb-3">
                                Data
                            </label>
                            <input 
                                type="date" 
                                id="data" 
                                name="data" 
                                min="{{ today }}"
                                required
                                class="w-full px-5 py-4 bg-moss border border-sand/10 rounded-sm text-sand font-mono
                                       focus:outline-none focus:border-clay transition-all">
                        </div>

                        <!-- Hora -->
                        <div>
                            <label for="hora" class="block text-sand/60 text-xs font-mono uppercase tracking-widest mb-3">
                                Horário
                            </label>
                            <select 
                                id="hora" 
                                name="hora" 
                                required
                                disabled
                                class="w-full px-5 py-4 bg-moss border border-sand/10 rounded-sm text-sand font-mono
                                       focus:outline-none focus:border-clay transition-all appearance-none cursor-pointer
                                       disabled:opacity-50 disabled:cursor-not-allowed
                                       [&>option]:bg-moss [&>option]:text-sand [&>option]:py-2">
                                <option value="">Selecione data e serviço primeiro</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Observações -->
                <div>
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-[1px] bg-clay"></div>
                        <label class="block text-sand font-display text-2xl font-bold">
                            Observações <span class="text-sand/40 text-base font-normal">(opcional)</span>
                        </label>
                    </div>
                    <textarea 
                        id="observacoes" 
                        name="observacoes" 
                        rows="5"
                        maxlength="500"
                        placeholder="Alguma preferência ou observação especial?"
                        class="w-full px-5 py-4 bg-moss border border-sand/10 rounded-sm text-sand placeholder-sand/30 
                               focus:outline-none focus:border-clay transition-all resize-none font-mono text-sm leading-relaxed"></textarea>
                    <p class="text-sand/40 text-xs mt-2 font-mono">Máximo 500 caracteres</p>
                </div>

                <!-- Informações Importantes -->
                <div class="bg-moss border border-sand/10 rounded-sm p-8">
                    <div class="flex items-center gap-3 mb-4">
                        <i class="fa-solid fa-info-circle text-clay text-lg"></i>
                        <h4 class="font-display text-sand font-bold text-lg">Informações importantes</h4>
                    </div>
                    <ul class="text-sand/60 text-sm space-y-3 font-mono">
                        <li class="flex items-start gap-3">
                            <i class="fa-solid fa-chevron-right text-clay text-xs mt-1"></i>
                            <span>Horário: Segunda a Sábado, 9h às 19h</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <i class="fa-solid fa-chevron-right text-clay text-xs mt-1"></i>
                            <span>Chegue com 5 minutos de antecedência</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <i class="fa-solid fa-chevron-right text-clay text-xs mt-1"></i>
                            <span>Cancelamentos: mínimo 2 horas de antecedência</span>
                        </li>
                    </ul>
                </div>

                <!-- Botões -->
                <div class="flex flex-col md:flex-row gap-4 pt-6">
                    <a href="{{ url_for('cliente_dashboard') }}" 
                       class="flex-1 bg-transparent border border-sand/20 text-sand px-8 py-4 rounded-sm font-display font-bold text-xs uppercase tracking-widest hover:border-sand/40 transition-all text-center">
                        Cancelar
                    </a>
                    <button 
                        type="submit" 
                        class="flex-1 bg-clay hover:bg-clay/90 text-sand px-8 py-4 rounded-sm font-display font-bold text-xs uppercase tracking-widest transition-all hover:scale-[1.02] shadow-lg">
                        <i class="fa-solid fa-check mr-2"></i>
                        Confirmar Agendamento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const dataInput = document.getElementById('data');
    const horaSelect = document.getElementById('hora');
    const servicoInputs = document.querySelectorAll('input[name="servico_id"]');
    const hoje = '{{ today }}';
    
    dataInput.min = hoje;

    // Função para carregar horários disponíveis
    async function carregarHorarios() {
        const servicoSelecionado = document.querySelector('input[name="servico_id"]:checked');
        const dataSelecionada = dataInput.value;
        
        // Limpar horários
        horaSelect.innerHTML = '<option value="">Selecione</option>';
        horaSelect.disabled = true;
        
        if (!servicoSelecionado || !dataSelecionada) {
            return;
        }
        
        // Verificar se é domingo
        const data = new Date(dataSelecionada + 'T00:00:00');
        if (data.getDay() === 0) {
            alert('Não abrimos aos domingos. Por favor, selecione outro dia.');
            dataInput.value = '';
            return;
        }
        
        try {
            horaSelect.innerHTML = '<option value="">Carregando...</option>';
            
            const response = await fetch(`/api/horarios-disponiveis?data=${dataSelecionada}&servico_id=${servicoSelecionado.value}`);
            const dados = await response.json();
            
            if (dados.bloqueado) {
                horaSelect.innerHTML = '<option value="">Indisponível</option>';
                alert(`Agenda bloqueada: ${dados.motivo}`);
                return;
            }
            
            if (dados.horarios && dados.horarios.length > 0) {
                horaSelect.innerHTML = '<option value="">Selecione</option>';
                dados.horarios.forEach(horario => {
                    const option = document.createElement('option');
                    option.value = horario;
                    option.textContent = horario;
                    horaSelect.appendChild(option);
                });
                horaSelect.disabled = false;
            } else {
                horaSelect.innerHTML = '<option value="">Sem horários disponíveis</option>';
            }
            
        } catch (error) {
            console.error('Erro ao carregar horários:', error);
            horaSelect.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    }
    
    // Event listeners
    dataInput.addEventListener('change', carregarHorarios);
    servicoInputs.forEach(input => {
        input.addEventListener('change', carregarHorarios);
    });
    
    // Desabilitar select de hora inicialmente
    horaSelect.disabled = true;
</script>
{% endblock %}
